---
- name: Install authbind
  apt:
    name: authbind

# https://superuser.com/questions/710253/allow-non-root-process-to-bind-to-port-80-and-443#892391
- name: Allow non-root process to bind to web ports
  file:
    path: '{{item}}'
    state: touch
    mode: '0777'
  with_items:
    - /etc/authbind/byport/80
    - /etc/authbind/byport/443

- name: Create group
  group:
    name: '{{application_group}}'
    state: present
    system: true

- name: Create user account
  user:
    name: '{{application_user}}'
    state: present
    system: true
    shell: /bin/bash

- name: Create a Buildbot master
  command: |
    sudo --user {{application_user}} \
        buildbot create-master {{home_dir}}/master
  args:
    chdir: '{{home_dir}}'
    creates: '{{home_dir}}/master'

- name: Insert Buildbot worker definition file
  template:
    src: workers.json.j2
    owner: '{{application_user}}'
    group: '{{application_group}}'
    dest: '{{home_dir}}/master/workers.json'
  notify:
    - Restart "build master" service

- name: Copy Buildbot configuration files into place
  copy:
    src: ../src/master/
    dest: '{{home_dir}}/master'
  notify:
    - Restart "build master" service

- name: Define a system service
  template:
    src: buildbot-master.service.j2
    dest: /etc/systemd/system/buildbot-master.service
  notify:
    - Restart "build master" service

- name: Enable system service
  systemd:
    name: buildbot-master
    enabled: true
